<!DOCTYPE html>
<html>
    <head>
            <meta charset="UTF-8">
            <link rel="stylesheet" href="bootstrap-3.3.7-dist/css/bootstrap.min.css" >
            <style>
                #parent {
                    display: flex;
                    flex-direction: column;
                    flex-wrap: nowrap;
                    border:3px black solid;
                    height:-webkit-fill-available;
                }
                #top-bar, #mid-section,  #coming-soon {
                    border:1px blue dashed;
                    display:flex;
                    flex-direction: row;
                    flex-wrap: nowrap;
                }
                #top-bar, #bot-section {
                    flex-grow: .15;
                }
                #coming-soon{
                    flex-grow: .10
                }
               
                #mid-section {
                    flex-grow: .60;
                }

                #entry, .measure, .handed { 
                    flex-grow: 1;
                    border:1px red dotted;
                }

                h1, h2, .measure {
                    text-align: center;
                }
                h2 { font-size: 1.1em; }
                .measure {
                    font-size: 36px; 
                }

                label { margin: 20px; }

                #mid-section, #coming-soon, #bot-section .content {
                    text-align: center;
                    font-size: 2em;
                }
                #coming-soon {
                    font-size: 1.2em; 
                }

                
                .measure {
                    background-color: tan;
                }
                .measure.uncounted {
                    background-color: transparent; 
                }
                .measure.current {
                    background-color: red;
                }
                
            </style>

            <script>
                var rhythms = [
                    "rhythm: 1 2½",
                    "rhythm: 2 3½",
                    "rhythm: 3 4½",
                    "rhythm: 1½ 4",
                    "rhythm: 1 3½",
                    "rhythm: 2 4½",
                    "rhythm: 1½ 3",
                    "rhythm: 2½ 4"
                ];
                var approaches = [
                    "♭dim -> minor approach",
                    "F7 -> E7 approach",
                    "V -> II V substitution",
                    "fills", 
                    "fills - campanas",
                    "tritone substitution",
                ]
                var lh_patterns = [
                    "walking bass (with arrastre)",
                    "walking bass, 1 y 3",
                    "3|3|3",
                    "bordoneo",
                    "milonga/habanera",
                    "milonga with run V->I",
                    "oompah 1 - 5",
                    "marcato arc",
                    "sincopa",
                    "RHYTHMS",
                    "stride",
                    "marcato and minor chroma descent",
                    "melody",
                    "expressive",
                    "blancas"
                ];
                var rh_patterns = [
                    "melody",
                    "melody - chords 1 y 3",
                    "melody - chords",
                    "melody - 6ths and 3rds",
                    "marcato arc",
                    "RHYTHMS",
                    "* bordoneo",
                    "* shearing",
                    "expressive"
                ];
                function registerEventListeners(){
                    var restartBtn = document.querySelector("#restart");
                    restartBtn.addEventListener("click", start);
                }
                function start(){
                    //1. get times
                    //2. clear measures and displays
                    //3. set up timers.

                    //1 
                    var times = getTimes(); 
                    console.log("times:", times); // JSON.stringify(times));
                    //2
                    resetMeasures()
                    resetDisplays();
                    //3
                    changeDisplays();
                    changeDisplays();
                    setTimers(times);
                }
                function getTimes(){
                    var bpmStr = document.querySelector("#bpm").value; 
                    var bpm = parseInt(bpmStr);
                    console.log("bpm!!", bpmStr, bpm);
                    var beatMs = (1000 * 60) / bpm;   //(1000 ms/s  * 60 s/m) / b/m ==> ms/beat
                    var measureTime = beatMs * 4;     // assuming 4/4 time
                    var phraseTime = measureTime * 4; // 4 measures per phrase.
                    return {bpm: bpm, beatMs: beatMs, measureTime:measureTime, phraseTime:phraseTime};
                }
                function resetMeasures(){
                    var measures = document.querySelectorAll(".measure");
                    measures.forEach(function(measure){
                        measure.classList.add("uncounted");
                        measure.classList.remove("current");
                    });
                    var current = document.querySelector(".measure");
                    current.classList.add("current");
                }
                function resetDisplays(){
                    var contents = document.querySelectorAll(".content");
                    contents.forEach(function(content){
                        content.textContent = "";
                    });
                }
                var upcomingLH, upcomingRH;
                function changeDisplays(){
                   var curLH = document.querySelector("#lh .content"),
                       curRH = document.querySelector("#rh .content"),
                       upcLH = document.querySelector("#lh-soon .content"),
                       upcRH = document.querySelector("#rh-soon .content");
                    curLH.textContent = upcLH.textContent;
                    curRH.textContent = upcRH.textContent;

                   nextPatterns = selectNextPatterns();
                   upcLH.textContent = nextPatterns.lh;
                   upcRH.textContent = nextPatterns.rh;
                }
                function changeApproach(){
                    var approach = document.querySelector("#bot-section .content");
                    approach.textContent = "";
                    if(Math.random() > .8){
                        approach.textContent = selectRandom(approaches);
                    }
                }
                var measureInterval, phraseInterval;
                function setTimers(times) {
                    //times => {bpm: bpm, beatMs: beatMs, measureTime:measureTime, phraseTime:phraseTime}
                    clearInterval(measureInterval);
                    clearInterval(phraseInterval);
                    measureInterval = setInterval(measureTimeoutF, times.measureTime);
                    phraseInterval  = setInterval(phraseTimeoutF, times.phraseTime);
                }
                function measureTimeoutF(){
                    var nextMeasure = document.querySelector(".measure.uncounted");
                    if(nextMeasure){
                        nextMeasure.classList.remove("uncounted");
                        nextMeasure.classList.remove("current");
                    }
                    nextMeasure = document.querySelector(".measure.uncounted");
                    if(nextMeasure){
                        nextMeasure.classList.add("current");
                    }
                    //console.log("measure complete");
                }
                function phraseTimeoutF(){
                    resetMeasures();
                    changeDisplays();
                    changeApproach();
                    //console.log("phrase complete");
                }
                function selectNextPatterns(){
                    var rh = selectRandom(rh_patterns);
                    var lh = selectRandom(lh_patterns);
                    if(rh == "RHYTHMS"){
                        rh = selectRandom(rhythms);
                    }
                    if(rh[0] == "*"){ lh = rh; }
                    if(lh == "RHYTHMS"){
                        lh = selectRandom(rhythms);
                    }
                    return {lh: lh, rh:rh};
                }
                function selectRandom(array){
                    var r = Math.random();
                    var i = Math.floor(r * array.length);
                    return array[i];
                }

            </script>
    </head>
    <body>
        <div id="parent">
            <div id="top-bar">
                <div id="entry">
                    <label>bpm: <input id="bpm" type="text" value="60"></label>
                    <input type="button" value="restart" id="restart">
                </div>
                <div class="measure uncounted">1</div>
                <div class="measure">2</div>
                <div class="measure">3</div>
                <div class="measure">4</div>
            </div>
            <div id="mid-section">
                <div id="lh" class="handed">
                    <h1>LH</h1>
                    <p class="content">walking</p>
                </div>
                <div id="rh" class="handed">
                        <h1>RH</h1>
                        <p class="content">melody</p>
                </div>
            </div>
            <div id="coming-soon">
                    <div id="lh-soon" class="handed">
                        <p class="content">walking</p>
                    </div>
                    <div id="rh-soon" class="handed">
                        <p class="content">melody</p>
                    </div>
                </div>
            <div id="bot-section">
                <h2>Approaches &amp; Substitutions</h2>
                <p class="content"></p>
            </div>
        </div>
        <script>
            registerEventListeners();
            start();
        </script>
    </body>
</html>